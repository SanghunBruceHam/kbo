<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBO ë§¤ì§/íŠ¸ë˜ì§ ë„˜ë²„ ê³„ì‚°ê¸° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        .controls h3 {
            margin-top: 0;
            color: #475569;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .results-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .team-col {
            font-weight: 600;
            background: #fafafa;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 60px;
        }
        .playoff-highlight {
            background-color: #fef3c7 !important;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        .magic-tragic-cell {
            padding: 6px;
            line-height: 1.4;
        }
        .magic-tragic-cell div {
            margin: 2px 0;
            font-size: 12px;
        }
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #e0f2fe;
            border-radius: 8px;
        }
        .description {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .description h3 {
            margin-top: 0;
            color: #1e40af;
        }
        
        /* ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” ìŠ¤íƒ€ì¼ - ìŠ¤í¬ë¦°ìƒ· ë§¤ì¹˜ */
        .results-table table {
            font-size: 11px;
            background: #2c3e50;
        }
        
        .results-table th {
            background: #2c3e50 !important;
            color: white;
            font-weight: bold;
            border: 1px solid #34495e;
            padding: 8px 6px;
        }
        
        .results-table td {
            border: 1px solid #34495e;
            padding: 8px 6px;
            font-weight: bold;
        }
        
        .team-col {
            background: #2c3e50 !important;
            color: white;
            width: 80px;
            min-width: 80px;
        }
        
        .rank-header {
            background: #34495e !important;
            color: white;
            width: 40px;
            min-width: 40px;
        }
        
        .playoff-rank-header {
            background: #f39c12 !important;
            color: white;
            width: 40px;
            min-width: 40px;
        }
        
        .team-info-cell {
            background: #2c3e50;
            color: white;
            text-align: left;
            padding: 6px 8px;
        }
        
        .team-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .team-status {
            font-size: 9px;
            color: #bdc3c7;
        }
        
        /* ë§¤ì§ë„˜ë²„ ì…€ ìƒ‰ìƒ */
        .magic-confirmed {
            background: #27ae60 !important;
            color: white;
        }
        
        .magic-safe {
            background: #2ecc71 !important;
            color: white;
        }
        
        .magic-warning {
            background: #f39c12 !important;
            color: white;
        }
        
        .magic-danger {
            background: #e74c3c !important;
            color: white;
        }
        
        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend-box {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
            vertical-align: middle;
        }
        
        .legend-box.confirmed { background: #27ae60; }
        .legend-box.safe { background: #2ecc71; }
        .legend-box.warning { background: #f39c12; }
        .legend-box.danger { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† KBO ë§¤ì§/íŠ¸ë˜ì§ ë„˜ë²„ ê³„ì‚°ê¸°</h1>
        
        <div class="description">
            <h3>ğŸ“‹ ê³„ì‚° ë°©ì‹ ì„¤ëª…</h3>
            <ul>
                <li><strong>ë§¤ì§ ë„˜ë²„ (Magic):</strong> kìœ„ ì´ë‚´ í™•ì •ì„ ìœ„í•´ í•„ìš”í•œ ìµœì†Œ ìŠ¹ìˆ˜</li>
                <li><strong>íŠ¸ë˜ì§ ë„˜ë²„ (Tragic):</strong> kìœ„ ì´ë‚´ ë‹¬ì„±ì´ ë¶ˆê°€ëŠ¥í•´ì§€ëŠ” ìµœëŒ€ íŒ¨ìˆ˜</li>
                <li><strong>ìŠ¹ë¥  ê³„ì‚°:</strong> W / (W + L) - ë¬´ìŠ¹ë¶€ëŠ” ë¶„ëª¨ì—ì„œ ì œì™¸</li>
                <li><strong>strict:</strong> ë™ë¥  ë¶ˆí—ˆ / <strong>tieOK:</strong> ë™ë¥  í—ˆìš©</li>
                <li><strong>5ìœ„ í•˜ì´ë¼ì´íŠ¸:</strong> í”Œë ˆì´ì˜¤í”„ ì§„ì¶œ ë¼ì¸</li>
            </ul>
        </div>

        <div class="controls">
            <h3>ğŸ”§ ì œì–´ ì˜µì…˜</h3>
            <button onclick="loadCurrentData()">ğŸ“Š í˜„ì¬ KBO ë°ì´í„° ë¡œë“œ</button>
            <button onclick="loadSampleData()">ğŸ² ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ</button>
            <button onclick="calculate()">âš¡ ê³„ì‚° ì‹¤í–‰</button>
            <button onclick="exportCSV()">ğŸ“„ CSV ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="exportJSON()">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
            <button onclick="toggleSimpleMode()">ğŸ¯ ë‹¨ìˆœí™” ëª¨ë“œ (strictë§Œ)</button>
        </div>

        <div id="results"></div>

        <div class="export-section">
            <h3>ğŸ’¡ ë‹µë³€</h3>
            <p><strong>Q1. íŒŒì¼ ì €ì¥:</strong> CSVì™€ JSON ë‘˜ ë‹¤ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. CSVëŠ” ì—‘ì…€ì—ì„œ ë³´ê¸° ì¢‹ê³ , JSONì€ í”„ë¡œê·¸ë˜ë° í™œìš©ì— ì¢‹ìŠµë‹ˆë‹¤.</p>
            <p><strong>Q2. 5ìœ„ í•˜ì´ë¼ì´íŠ¸:</strong> í”Œë ˆì´ì˜¤í”„ ë¼ì¸ì¸ 5ìœ„ ì»¬ëŸ¼ì„ ë…¸ë€ìƒ‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.</p>
            <p><strong>Q3. ë‹¨ìˆœí™” ëª¨ë“œ:</strong> strictë§Œ ì‚¬ìš©í•˜ëŠ” ë²„ì „ë„ í† ê¸€ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        let teams = [];
        let results = [];
        let isSimpleMode = false;

        /**
         * KBO: 1~9ìœ„(â‰¤kìœ„) í™•ì •/íƒˆë½ ë§¤ì§Â·íŠ¸ë˜ì§ ë„˜ë²„ (ì”ì—¬ê²½ê¸° Rë¡œ ìº¡í•‘ í‘œê¸°)
         */
        function calcR(team, season = 144) {
            return season - (team.W + team.L + team.T);
        }

        function pNow(team) {
            const denom = team.W + team.L;
            return denom > 0 ? team.W / denom : 0;
        }

        function pMax(team, R) {
            const denom = team.W + team.L + R;
            return denom > 0 ? (team.W + R) / denom : 0;
        }

        function pMin(team, R) {
            const denom = team.W + team.L + R;
            return denom > 0 ? team.W / denom : 0;
        }

        function clamp(v, lo, hi) {
            return Math.max(lo, Math.min(hi, v));
        }

        function round3(x) {
            return Number(x.toFixed(3));
        }

        function kthLargest(arr, k) {
            if (!arr.length || k < 1) return 0;
            const sorted = [...arr].sort((a, b) => b - a);
            return sorted[k - 1] ?? 0;
        }

        function kBenchmarksForTeam(team, teams, season, k) {
            const maxList = [];
            const minList = [];
            for (const t of teams) {
                if (t.id === team.id) continue;
                const R = calcR(t, season);
                maxList.push(pMax(t, R));
                minList.push(pMin(t, R));
            }
            return {
                Kk_max: kthLargest(maxList, k),
                Kk_min: kthLargest(minList, k),
            };
        }

        function magicTragicForK(team, season, Kk_max, Kk_min) {
            const R = calcR(team, season);
            const D = team.W + team.L + R;

            // Magic
            const rhsMagic = Kk_max * D - team.W;
            const x_strict_raw = Math.max(0, Math.floor(rhsMagic) + 1);
            const x_tieOK_raw = Math.max(0, Math.ceil(rhsMagic));
            const x_strict = clamp(x_strict_raw, 0, R);
            const x_tieOK = clamp(x_tieOK_raw, 0, R);

            // Tragic
            const rhsTr = team.W + R - Kk_min * D;
            const y_strict_raw = Math.max(0, Math.ceil(rhsTr));
            const y_tieOK_raw = Math.max(0, Math.floor(rhsTr) + 1);
            const y_strict = clamp(y_strict_raw, 0, R);
            const y_tieOK = clamp(y_tieOK_raw, 0, R);

            return { R, Kk_max, Kk_min, x_strict, x_tieOK, y_strict, y_tieOK };
        }

        function kboMagicTragicRanksAll(teams, season = 144) {
            const ks = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            return teams.map(team => {
                const R = calcR(team, season);
                const row = {
                    team: team.id,
                    W: team.W, L: team.L, T: team.T, R,
                    winPct: round3(pNow(team)),
                };

                for (const k of ks) {
                    const { Kk_max, Kk_min } = kBenchmarksForTeam(team, teams, season, k);
                    const r = magicTragicForK(team, season, Kk_max, Kk_min);
                    row[`K${k}_max`] = round3(r.Kk_max);
                    row[`K${k}_min`] = round3(r.Kk_min);
                    row[`x${k}_strict`] = r.x_strict;
                    row[`x${k}_tieOK`] = r.x_tieOK;
                    row[`y${k}_strict`] = r.y_strict;
                    row[`y${k}_tieOK`] = r.y_tieOK;
                }
                return row;
            });
        }

        // í˜„ì¬ KBO ë°ì´í„° ë¡œë“œ
        async function loadCurrentData() {
            try {
                const response = await fetch('magic-number/data/api-data.json');
                const data = await response.json();
                
                teams = data.standings.map(team => ({
                    id: team.team,
                    W: team.wins,
                    L: team.losses,
                    T: team.draws
                }));
                
                alert('âœ… í˜„ì¬ KBO ë°ì´í„° ë¡œë“œ ì™„ë£Œ!');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            teams = [
                { id: "KIA", W: 70, L: 55, T: 3 },
                { id: "LG", W: 72, L: 53, T: 3 },
                { id: "SSG", W: 66, L: 60, T: 2 },
                { id: "LOTTE", W: 64, L: 61, T: 3 },
                { id: "NC", W: 63, L: 62, T: 3 },
                { id: "KT", W: 62, L: 63, T: 3 },
                { id: "DOO", W: 61, L: 64, T: 3 },
                { id: "HAN", W: 60, L: 65, T: 3 },
                { id: "KWO", W: 58, L: 67, T: 3 },
                { id: "SAM", W: 57, L: 68, T: 3 },
            ];
            alert('âœ… ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!');
        }

        // ê³„ì‚° ì‹¤í–‰
        function calculate() {
            if (teams.length === 0) {
                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }

            results = kboMagicTragicRanksAll(teams, 144);
            renderResults();
        }

        // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§ - ë§¤íŠ¸ë¦­ìŠ¤ ìŠ¤íƒ€ì¼
        function renderResults() {
            if (results.length === 0) return;

            // ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ 9ìœ„ë¶€í„° 1ìœ„ ìˆœì„œë¡œ ë°°ì—´
            const ranks = [9, 8, 7, 6, 5, 4, 3, 2, 1];
            
            let html = '<div class="results-table"><table>';
            
            // ìµœìƒë‹¨ í—¤ë” - ìˆœìœ„
            html += '<thead><tr>';
            html += '<th rowspan="2" class="team-col">êµ¬ë‹¨</th>';
            html += '<th colspan="9" style="background: #1f2937; color: white; font-size: 16px; font-weight: bold;">ìˆœìœ„</th>';
            html += '</tr>';
            
            // ìˆœìœ„ ë²ˆí˜¸ í—¤ë”
            html += '<tr>';
            for (const rank of ranks) {
                const isPlayoff = rank === 5;
                const headerClass = isPlayoff ? 'playoff-rank-header' : 'rank-header';
                html += `<th class="${headerClass}">${rank}</th>`;
            }
            html += '</tr></thead>';
            
            html += '<tbody>';

            // ê° íŒ€ë³„ í–‰ ìƒì„±
            for (const row of results) {
                html += '<tr>';
                
                // íŒ€ ì •ë³´ (ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ "Xìœ„ í™•ë³´" ìŠ¤íƒ€ì¼)
                const currentRank = getCurrentRank(row, results);
                html += `<td class="team-info-cell">
                    <div class="team-name">${row.team}</div>
                    <div class="team-status">${currentRank}ìœ„ í™•ë³´</div>
                </td>`;
                
                // ê° ìˆœìœ„ë³„ ë§¤ì§ ë„˜ë²„
                for (const rank of ranks) {
                    const magicValue = row[`x${rank}_strict`];
                    const cellClass = getMagicCellClass(magicValue, row.R);
                    const displayValue = magicValue === 0 ? 'í™•ì •' : (magicValue >= row.R ? `${magicValue}` : magicValue);
                    
                    html += `<td class="${cellClass}">${displayValue}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table></div>';
            
            // ë²”ë¡€ ì¶”ê°€
            html += '<div class="legend" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 10px 0;">ğŸ¨ ìƒ‰ìƒ êµ¬ë¶„</h4>';
            html += '<div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px;">';
            html += '<span><span class="legend-box confirmed"></span> í™•ì • (ë§¤ì§ ë„˜ë²„ 0)</span>';
            html += '<span><span class="legend-box safe"></span> ì•ˆì „ (ë§¤ì§ ë„˜ë²„ 1-5)</span>';
            html += '<span><span class="legend-box warning"></span> ì£¼ì˜ (ë§¤ì§ ë„˜ë²„ 6-10)</span>';
            html += '<span><span class="legend-box danger"></span> ìœ„í—˜ (ë§¤ì§ ë„˜ë²„ 11+)</span>';
            html += '</div></div>';
            
            document.getElementById('results').innerHTML = html;
        }

        // í˜„ì¬ ìˆœìœ„ ê³„ì‚° (ìŠ¹ë¥  ê¸°ì¤€)
        function getCurrentRank(targetTeam, allResults) {
            const sorted = [...allResults].sort((a, b) => b.winPct - a.winPct);
            return sorted.findIndex(team => team.team === targetTeam.team) + 1;
        }

        // ë§¤ì§ ë„˜ë²„ ê°’ì— ë”°ë¥¸ ì…€ í´ë˜ìŠ¤ ê²°ì •
        function getMagicCellClass(magicValue, remainingGames) {
            if (magicValue === 0) return 'magic-confirmed'; // í™•ì • (ë…¹ìƒ‰)
            if (magicValue <= 5) return 'magic-safe'; // ì•ˆì „ (ì—°í•œ ë…¹ìƒ‰) 
            if (magicValue <= 10) return 'magic-warning'; // ì£¼ì˜ (ë…¸ë€ìƒ‰)
            return 'magic-danger'; // ìœ„í—˜ (ë¹¨ê°„ìƒ‰)
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function exportCSV() {
            if (results.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const headers = Object.keys(results[0]);
            const csvContent = [
                headers.join(','),
                ...results.map(row => headers.map(h => row[h]).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `kbo_magic_tragic_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // JSON ë‹¤ìš´ë¡œë“œ
        function exportJSON() {
            if (results.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const jsonContent = JSON.stringify(results, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `kbo_magic_tragic_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
        }

        // ë‹¨ìˆœí™” ëª¨ë“œ í† ê¸€
        function toggleSimpleMode() {
            isSimpleMode = !isSimpleMode;
            const button = event.target;
            button.textContent = isSimpleMode ? 'ğŸ¯ ì „ì²´ ëª¨ë“œ (strict+tieOK)' : 'ğŸ¯ ë‹¨ìˆœí™” ëª¨ë“œ (strictë§Œ)';
            
            if (results.length > 0) {
                renderResults();
            }
        }

        // ì´ˆê¸° ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        loadSampleData();
        calculate();
    </script>
</body>
</html>