<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBO ë§¤ì§/íŠ¸ë˜ì§ ë„˜ë²„ ê³„ì‚°ê¸° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            margin-bottom: 30px;
            padding: 20px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        .controls h3 {
            margin-top: 0;
            color: #475569;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .results-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        .team-col {
            font-weight: 600;
            background: #fafafa;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 60px;
        }
        .playoff-highlight {
            background-color: #fef3c7 !important;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        tr:hover {
            background-color: #f3f4f6;
        }
        .magic-tragic-cell {
            padding: 6px;
            line-height: 1.4;
        }
        .magic-tragic-cell div {
            margin: 2px 0;
            font-size: 12px;
        }
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #e0f2fe;
            border-radius: 8px;
        }
        .description {
            background: #eff6ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .description h3 {
            margin-top: 0;
            color: #1e40af;
        }
        
        /* ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .results-table table {
            font-size: 14px;
        }
        
        .results-table th,
        .results-table td {
            border: 1px solid #34495e;
            padding: 10px 8px;
            text-align: center;
        }
        
        .results-table th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }
        
        .results-table td {
            font-weight: bold;
            font-size: 14px;
        }
        
        .team-info-cell {
            background: #34495e;
            color: white;
            text-align: left;
        }
        
        .playoff-rank-header {
            background: #f39c12;
        }
        
        .team-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .team-status {
            font-size: 11px;
            color: #bdc3c7;
        }
        
        /* ë§¤ì§ë„˜ë²„ ì…€ ìƒ‰ìƒ - root index ìŠ¤íƒ€ì¼ */
        .magic-confirmed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(22, 163, 74, 0.35) 100%);
            color: #059669;
            font-weight: bold;
        }
        
        .magic-safe {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(22, 163, 74, 0.15) 100%);
            color: #059669;
            font-weight: 600;
        }
        
        .magic-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(245, 158, 11, 0.25) 100%);
            color: #f59e0b;
            font-weight: 600;
        }
        
        .magic-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.25) 100%);
            color: #dc2626;
            font-weight: 600;
        }
        
        .magic-selflimit {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(245, 158, 11, 0.35) 100%);
            color: #f59e0b;
            font-weight: bold;
        }
        
        .team-logo {
            width: 18px;
            height: 18px;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .legend-box {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
            vertical-align: middle;
        }
        
        .legend-box.confirmed { background: #27ae60; }
        .legend-box.safe { background: #2ecc71; }
        .legend-box.warning { background: #f39c12; }
        .legend-box.danger { background: #e74c3c; }
        .legend-box.impossible { background: #6b7280; }

        /* 5ìœ„(í”Œë ˆì´ì˜¤í”„ ë¼ì¸) ì¢Œì¸¡ êµµì€ êµ¬ë¶„ì„  */
        .playoff-divider-left {
            border-left: 4px solid #f39c12 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ† 2025 KBO ë§¤ì§/íŠ¸ë˜ì§ ë„˜ë²„ ì‹¤ì‹œê°„ ê³„ì‚°</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button onclick="refreshData()" style="background: #10b981; font-size: 14px;">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="results"></div>

    </div>

    <script>
        let teams = [];
        let results = [];
        let isSimpleMode = false;
        let currentRanksMap = new Map(); // team -> rank (from calc-magic-numbers.json results[])
        let remainingMap    = new Map(); // team -> remainingGames (from playoffResults[])

        /**
         * KBO: 1~9ìœ„(â‰¤kìœ„) í™•ì •/íƒˆë½ ë§¤ì§Â·íŠ¸ë˜ì§ ë„˜ë²„ (ì”ì—¬ê²½ê¸° Rë¡œ ìº¡í•‘ í‘œê¸°)
         */
        function calcR(team, season = 144) {
            return team.actualR || (season - (team.W + team.L + team.T));
        }

        function pNow(team) {
            const denom = team.W + team.L;
            return denom > 0 ? team.W / denom : 0;
        }

        function pMax(team, R) {
            const denom = team.W + team.L + R;
            return denom > 0 ? (team.W + R) / denom : 0;
        }

        function pMin(team, R) {
            const denom = team.W + team.L + R;
            return denom > 0 ? team.W / denom : 0;
        }

        function clamp(v, lo, hi) {
            return Math.max(lo, Math.min(hi, v));
        }

        function round3(x) {
            return Number(x.toFixed(3));
        }

        function kthLargest(arr, k) {
            if (!arr.length || k < 1) return 0;
            const sorted = [...arr].sort((a, b) => b - a);
            return sorted[k - 1] ?? 0;
        }

        function kBenchmarksForTeam(team, teams, season, k)
        {
            const maxList = [];
            const minList = [];
            for (const t of teams) {
                if (t.id === team.id) continue;
                const R = remainingMap.has(t.id) ? remainingMap.get(t.id) : calcR(t, season);
                maxList.push(pMax(t, R));
                minList.push(pMin(t, R));
            }
            return {
                Kk_max: kthLargest(maxList, k),
                Kk_min: kthLargest(minList, k),
            };
        }

        function magicTragicForK(team, season, Kk_max, Kk_min) {
            const R = remainingMap.has(team.id) ? remainingMap.get(team.id) : calcR(team, season);
            const D = team.W + team.L + R;

            // Magic
            const rhsMagic = Kk_max * D - team.W;
            const x_strict_raw = Math.max(0, Math.floor(rhsMagic) + 1);
            const x_tieOK_raw = Math.max(0, Math.ceil(rhsMagic));
            const x_strict = clamp(x_strict_raw, 0, R);
            const x_tieOK = clamp(x_tieOK_raw, 0, R);

            // Tragic
            const rhsTr = team.W + R - Kk_min * D;
            const y_strict_raw = Math.max(0, Math.ceil(rhsTr));
            const y_tieOK_raw = Math.max(0, Math.floor(rhsTr) + 1);
            const y_strict = clamp(y_strict_raw, 0, R);
            const y_tieOK = clamp(y_tieOK_raw, 0, R);

            return { R, Kk_max, Kk_min, x_strict, x_tieOK, y_strict, y_tieOK, x_strict_raw, x_tieOK_raw, y_strict_raw, y_tieOK_raw };
        }

        function kboMagicTragicRanksAll(teams, season = 144) {
            const ks = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            return teams.map(team => {
                const R = remainingMap.has(team.id) ? remainingMap.get(team.id) : calcR(team, season);
                const row = {
                    team: team.id,
                    W: team.W, L: team.L, T: team.T, R,
                    winPct: round3(pNow(team)),
                    _jsonRank: currentRanksMap.get(team.id) ?? null
                };

                for (const k of ks) {
                    const { Kk_max, Kk_min } = kBenchmarksForTeam(team, teams, season, k);
                    const r = magicTragicForK(team, season, Kk_max, Kk_min);
                    row[`K${k}_max`] = round3(r.Kk_max);
                    row[`K${k}_min`] = round3(r.Kk_min);
                    row[`x${k}_strict`] = r.x_strict;
                    row[`x${k}_tieOK`] = r.x_tieOK;
                    row[`y${k}_strict`] = r.y_strict;
                    row[`y${k}_tieOK`] = r.y_tieOK;
                    row[`x${k}_strict_raw`] = r.x_strict_raw;
                    row[`x${k}_tieOK_raw`] = r.x_tieOK_raw;
                    row[`y${k}_strict_raw`] = r.y_strict_raw;
                    row[`y${k}_tieOK_raw`] = r.y_tieOK_raw;
                }
                return row;
            });
        }

        // í˜„ì¬ KBO ë°ì´í„° ë¡œë“œ
        async function loadCurrentData() {
            try {
                const response = await fetch('magic-number/data/calc-magic-numbers.json');
                const data = await response.json();

                // 1) team W/L/T + remaining from playoffResults[]
                if (Array.isArray(data.playoffResults)) {
                    teams = data.playoffResults.map(r => ({
                        id: r.team,
                        W: r.wins,
                        L: r.losses,
                        T: r.draws ?? 0
                    }));
                    remainingMap = new Map(data.playoffResults.map(r => [r.team, r.remainingGames]));
                } else {
                    teams = [];
                    remainingMap = new Map();
                }

                // 2) current ranks from results[] (if provided)
                if (Array.isArray(data.results)) {
                    currentRanksMap = new Map(data.results.map(r => [r.team, r.rank]));
                } else {
                    currentRanksMap = new Map();
                }

                console.log('calc-magic-numbers.json ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('calc-magic-numbers.json ë¡œë“œ ì‹¤íŒ¨:', error);
                // í´ë°±: ìƒ˜í”Œ ë°ì´í„°
                loadSampleData();
            }
        }

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            teams = [
                { id: "KIA", W: 70, L: 55, T: 3 },
                { id: "LG", W: 72, L: 53, T: 3 },
                { id: "SSG", W: 66, L: 60, T: 2 },
                { id: "LOTTE", W: 64, L: 61, T: 3 },
                { id: "NC", W: 63, L: 62, T: 3 },
                { id: "KT", W: 62, L: 63, T: 3 },
                { id: "DOO", W: 61, L: 64, T: 3 },
                { id: "HAN", W: 60, L: 65, T: 3 },
                { id: "KWO", W: 58, L: 67, T: 3 },
                { id: "SAM", W: 57, L: 68, T: 3 },
            ];
            console.log('ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!');
        }

        // ê³„ì‚° ì‹¤í–‰
        function calculate() {
            if (teams.length === 0) return;

            results = kboMagicTragicRanksAll(teams, 144);
            renderResults();
        }

        // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§ - ë§¤íŠ¸ë¦­ìŠ¤ ìŠ¤íƒ€ì¼ (magic, tragic, impossible í¬í•¨)
        function renderResults() {
            if (results.length === 0) return;

            const ranks = [9, 8, 7, 6, 5, 4, 3, 2, 1];
            let html = '<div class="results-table"><table>';

            // Header
            html += '<thead><tr>';
            html += '<th rowspan="2" class="team-col">êµ¬ë‹¨</th>';
            html += '<th colspan="9" style="background: #34495e; color: white; font-size: 16px; font-weight: bold;">ìˆœìœ„</th>';
            html += '</tr><tr>';
            for (const rank of ranks) {
                const headerClass = (rank === 5) ? 'playoff-rank-header' : 'rank-header';
                html += `<th class="${headerClass}">${rank}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (const row of results) {
                const currentRank = getCurrentRank(row, results);
                html += '<tr>';
                // íŒ€ëª… ë§¤í•‘ (í•œê¸€ -> ì˜ë¬¸)
                const teamNameMap = {
                    'LG': 'lg',
                    'í•œí™”': 'hanwha',
                    'SSG': 'ssg',
                    'ì‚¼ì„±': 'samsung',
                    'KT': 'kt',
                    'ë¡¯ë°': 'lotte',
                    'NC': 'nc',
                    'KIA': 'kia',
                    'ë‘ì‚°': 'doosan',
                    'í‚¤ì›€': 'kiwoom'
                };
                const logoName = teamNameMap[row.team] || row.team.toLowerCase();
                
                html += `<td class="team-info-cell">
                    <div class="team-name">
                        <img src="magic-number/images/teams/${logoName}.png" class="team-logo" alt="${row.team}" onerror="this.style.display='none'">
                        ${row.team}
                    </div>
                    <div class="team-status">í˜„ì¬ ${currentRank}ìœ„ Â· ì”ì—¬ ${row.R}ê²½ê¸°</div>
                </td>`;

                for (const rank of ranks) {
                    const x = row[`x${rank}_strict`];       // Magic: strict (>)
                    const y = row[`y${rank}_tieOK`];        // Tragic: tieOK (<)
                    const xraw = row[`x${rank}_strict_raw`];
                    const yraw = row[`y${rank}_tieOK_raw`]; // optional debug
                    const R = row.R;

                    let label = '';
                    let cls = '';
                    // ìƒ‰ìƒ ê·œì¹™ (Magic=strict, Tragic=tieOK)
                    if (rank < currentRank) {
                        // í˜„ì¬ë³´ë‹¤ ë†’ì€(ë” ì¢‹ì€) ìˆœìœ„ â†’ íŠ¸ë˜ì§ë„˜ë²„ ë¹¨ê°• ìš°ì„ 
                        if (y === 0) {
                            label = `${rank}ìœ„ ë¶ˆê°€`;
                        } else {
                            label = String(y); // TN
                        }
                        cls = 'magic-danger';
                    } else if (rank === currentRank && xraw > R) {
                        // í˜„ì¬ ìˆœìœ„ë¥¼ ìë ¥ìœ¼ë¡œ í™•ì •í•  ìˆ˜ ì—†ìŒ â†’ ë…¸ë€ìƒ‰(ì”ì—¬ê²½ê¸°ìˆ˜)
                        label = String(R);
                        cls = 'magic-selflimit';
                    } else if (y === 0) {
                        // íŠ¸ë˜ì§ë„˜ë²„ 0 â†’ í•´ë‹¹ ìˆœìœ„ ë¶ˆê°€
                        label = `${rank}ìœ„ ë¶ˆê°€`;
                        cls = 'magic-danger';
                    } else if (xraw > R) {
                        // ì¼ë°˜ ìë ¥ë¶ˆê°€(í•´ë‹¹ ì¹¸)
                        label = String(R);
                        cls = 'magic-selflimit';
                    } else if (x === 0) {
                        // í™•ì •
                        label = 'í™•ë³´';
                        cls = 'magic-confirmed';
                    } else {
                        // ë§¤ì§ë„˜ë²„ í‘œì‹œ êµ¬ê°„ (ê¸°ë³¸: ë§¤ì§ì€ ì´ˆë¡ ë‹¨ì¼í†¤)
                        label = String(x);
                        cls = 'magic-safe';
                    }

                    const divider = (rank === 5) ? 'playoff-divider-left' : '';
                    html += `<td class="magic-tragic-cell ${cls} ${divider}">${label}</td>`;
                }

                html += '</tr>';
            }

            html += '</tbody></table></div>';
            document.getElementById('results').innerHTML = html;
        }

        // í˜„ì¬ ìˆœìœ„ ê³„ì‚° (JSONì—ì„œ ì œê³µì‹œ ìš°ì„ )
        function getCurrentRank(targetTeam, allResults) {
            if (targetTeam._jsonRank != null) return targetTeam._jsonRank;
            const sorted = [...allResults].sort((a, b) => b.winPct - a.winPct);
            return sorted.findIndex(team => team.team === targetTeam.team) + 1;
        }

        // ì…€ì— í‘œì‹œí•  í…ìŠ¤íŠ¸ ê²°ì • (magic, tragic, impossible)
        function displayLabel(x, y, rank){
            if (y === 0) return `${rank}ìœ„ ë¶ˆê°€`;
            if (x === 0) return 'í™•ë³´';
            return String(x); // ê¸°ë³¸ì€ ë§¤ì§ë„˜ë²„ í‘œê¸°
        }

        // magic/tragic ê°’ì— ë”°ë¥¸ ì…€ í´ë˜ìŠ¤ ê²°ì •
        function chooseCellClass(x, y){
            if (y === 0) return 'magic-impossible';
            if (x === 0) return 'magic-confirmed';
            if (x <= 5) return 'magic-safe';
            if (x <= 10) return 'magic-warning';
            return 'magic-danger';
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function exportCSV() {
            if (results.length === 0) return;

            const headers = Object.keys(results[0]);
            const csvContent = [
                headers.join(','),
                ...results.map(row => headers.map(h => row[h]).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `kbo_magic_tragic_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // JSON ë‹¤ìš´ë¡œë“œ
        function exportJSON() {
            if (results.length === 0) return;

            const jsonContent = JSON.stringify(results, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `kbo_magic_tragic_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
        }

        // ë‹¨ìˆœí™” ëª¨ë“œ í† ê¸€
        function toggleSimpleMode() {
            isSimpleMode = !isSimpleMode;
            const button = event.target;
            button.textContent = isSimpleMode ? 'ğŸ¯ ì „ì²´ ëª¨ë“œ (strict+tieOK)' : 'ğŸ¯ ë‹¨ìˆœí™” ëª¨ë“œ (strictë§Œ)';
            
            if (results.length > 0) {
                renderResults();
            }
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            console.log('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
            await loadCurrentData();
            if (teams.length > 0) {
                calculate();
                console.log('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!');
            }
        }

        // ì´ˆê¸° í˜„ì¬ KBO ë°ì´í„° ë¡œë“œ
        async function init() {
            await loadCurrentData();
            if (teams.length > 0) {
                calculate();
            }
        }
        
        init();
</script>
</body>
</html>